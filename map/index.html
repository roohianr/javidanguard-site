<!doctype html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>نقشه</title>
  <link rel="stylesheet" href="https://unpkg.com/maplibre-gl/dist/maplibre-gl.css">
  <style>
    html, body { height: 100%; margin: 0; }
    #map { height: 100%; width: 100%; }
    .ui { position:absolute; top:12px; right:12px; z-index:10; display:grid; gap:8px; pointer-events:none; }
    .card { pointer-events:auto; background:rgba(0,0,0,.6); color:#fff; backdrop-filter:blur(6px); border-radius:10px; padding:10px 12px; min-width:280px; }
    .row { display:flex; gap:6px; align-items:center; flex-wrap:wrap; }
    input, select, button { font:inherit; }
    input[type="text"] { flex:1 1 160px; min-width:0; padding:6px 8px; border-radius:8px; border:1px solid #444; background:#111; color:#fff; }
    button { padding:6px 10px; border-radius:8px; border:1px solid #444; background:#1a1a1a; color:#fff; cursor:pointer; }
    button:hover { background:#222; }
    select { padding:6px 8px; border-radius:8px; border:1px solid #444; background:#111; color:#fff; }
    .pill { font-size:12px; opacity:.9; background:#111; border:1px solid #444; border-radius:999px; padding:2px 8px; }
    .badge{ position:absolute; left:12px; bottom:12px; background:#000a; color:#fff; padding:6px 8px; border-radius:8px; font:12px/1.2 system-ui; }
  </style>
</head>
<body>
  <div id="map"></div>

  <div class="ui">
    <div class="card">
      <div class="row">
        <input id="search" placeholder="جستجوی شهر (تهران، شیراز…)" />
        <button id="goto">برو</button>
      </div>
      <div class="row"><span class="pill" id="zoomLabel">زوم: —</span><span class="pill" id="cellLabel">سلول: —</span></div>
      <div class="row" style="margin-top:8px">
        <label>ما چند نفر هستیم:</label>
        <select id="bucket">
          <option value="0">۱</option>
          <option value="1">۲–۵</option>
          <option value="2">۶–۱۰</option>
          <option value="3">۱۱–۲۰</option>
          <option value="4">۲۰+</option>
        </select>
        <button id="add">افزودن گروه</button>
      </div>
      <div class="hint">آیکون‌ها تعداد افراد را نشان می‌دهند و با زوم به مناطق کوچک‌تر تقسیم می‌شوند.</div>

      <!-- TEMP: one-click test to prove icons layer works -->
      <div class="row"><button id="testIcon">Test icon here</button></div>
    </div>
  </div>

  <div class="badge" id="dbg">init…</div>

  <script src="https://unpkg.com/maplibre-gl/dist/maplibre-gl.js"></script>
  <script src="https://unpkg.com/h3-js@4.1.0/dist/h3-js.umd.js"></script>
  <script>
    (async () => {
    try {
      const r = await fetch('/api/me', { credentials: 'include' });
      if (!r.ok) location.replace('/auth/');
    } catch { location.replace('/auth/'); }
  })();
    const dbg = (t)=>{ const el=document.getElementById('dbg'); el.textContent=t; console.log('[DBG]',t); };
    const H3 = window.h3 || window.h3core;

    // Soldier icon (SVG) as data URL
    const soldierSVG = encodeURIComponent(`<svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="#10b981"><path d="M12 2a3 3 0 1 1 0 6 3 3 0 0 1 0-6zm-5 9h10l2 7h-3v4h-2v-4h-4v4H8v-4H5l2-7z"/></svg>`);
    const soldierURL = `data:image/svg+xml;charset=utf-8,${soldierSVG}`;

    const map = new maplibregl.Map({
      container: 'map',
      style: {
        version: 8,
        sources: {
          osm: { type:'raster', tiles:['https://tile.openstreetmap.org/{z}/{x}/{y}.png'], tileSize:256, attribution:'© OpenStreetMap' }
        },
        layers: [{ id:'osm', type:'raster', source:'osm' }]
      },
      center: [54, 32], zoom: 4.5, minZoom: 3, maxZoom: 16
    });
    map.addControl(new maplibregl.NavigationControl(), 'top-right');
    map.on('error', e => console.warn('map error', e));

    map.on('load', async () => {
      dbg('map loaded');

      // Ensure icon is registered BEFORE layer is added (prevents silent no-icon)
      await ensureSoldierImage();

      // Aggregated points
      map.addSource('agg', { type:'geojson', data: { type:'FeatureCollection', features:[] } });
      map.addLayer({
        id:'agg-icons', type:'symbol', source:'agg',
        layout:{
          'icon-image': 'soldier',
          'icon-size': ['interpolate',['linear'],['zoom'], 4,0.6, 10,1.0, 16,1.6],
          'icon-allow-overlap': true,
          'text-field': ['to-string', ['get','count']],
          'text-font': ['Open Sans Bold','Arial Unicode MS Bold'],
          'text-size': ['interpolate',['linear'],['zoom'], 4,11, 10,13, 16,16],
          'text-offset': [0, -1.2],
          'text-allow-overlap': true
        },
        paint:{
          'text-color': '#ffffff',
          'text-halo-color': '#0b0b0b',
          'text-halo-width': 1.6
        }
      });

      // Selected hex preview for submit clarity
      map.addSource('selected', { type:'geojson', data:{ type:'FeatureCollection', features:[] } });
      map.addLayer({ id:'selected-fill', type:'fill', source:'selected',
        paint:{ 'fill-color':'#ffffff', 'fill-opacity':0.10 }});
      map.addLayer({ id:'selected-line', type:'line', source:'selected',
        paint:{ 'line-color':'#ffffff', 'line-width':1.0 }});

      updateSelected();
      refreshAgg();
    });

    async function ensureSoldierImage() {
      if (map.hasImage('soldier')) return;
      const img = await new Promise((resolve, reject) => {
        map.loadImage(soldierURL, (err, img) => err ? reject(err) : resolve(img));
      });
      map.addImage('soldier', img, { pixelRatio: 2 });
    }

    function updateSelected(){
      try{
        const c = map.getCenter();
        const cell = H3.latLngToCell(c.lat, c.lng, 8);
        const boundary = H3.cellToBoundary(cell, true).map(([lat,lng])=>[lng,lat]);
        const gj = { type:'FeatureCollection', features:[{ type:'Feature', properties:{cell}, geometry:{ type:'Polygon', coordinates:[[...boundary, boundary[0]]] } }] };
        map.getSource('selected')?.setData(gj);
        document.getElementById('zoomLabel').textContent = `زوم: ${map.getZoom().toFixed(1)}`;
        document.getElementById('cellLabel').textContent = `سلول: ${cell}`;
      } catch(e){ /* ignore */ }
    }
    let t;
    map.on('move', updateSelected);
    map.on('moveend', () => { clearTimeout(t); t=setTimeout(refreshAgg, 250); });

    async function refreshAgg(){
      const b = map.getBounds(); const z = map.getZoom();
      const url = `/api/agg2?bbox=${b.getWest()},${b.getSouth()},${b.getEast()},${b.getNorth()}&z=${z.toFixed(1)}&_t=${Date.now()}`;
      try {
        const r = await fetch(url, { cache:'no-store' });
        if (!r.ok) throw new Error('agg '+r.status);
        const gj = await r.json();
        map.getSource('agg')?.setData(gj);
        dbg(`icons: ${gj.features?.length || 0}`);
      } catch(e) { dbg('agg error'); console.warn(e); }
    }

    // TEMP sanity: draw one icon at center to verify the layer
    document.getElementById('testIcon').onclick = () => {
      const c = map.getCenter();
      const test = { type:'FeatureCollection', features:[{ type:'Feature', properties:{ count:7, cell:'test' }, geometry:{ type:'Point', coordinates:[c.lng,c.lat] } }] };
      map.getSource('agg')?.setData(test);
      dbg('icons: 1 (test)');
    };
     // Always include credentials so your session cookie is sent
  async function fetchAnnotations(bbox, z, kind='') {
    const qs = new URLSearchParams({ bbox, z: String(z) });
    if (kind) qs.set('kind', kind);
    const r = await fetch('/api/ann?' + qs.toString(), { credentials:'include' });
    if (!r.ok) throw new Error('ann list ' + r.status);
    return r.json(); // GeoJSON FeatureCollection
  }

  async function createAnnotation(cell_h3, kind, title='', details='') {
    const r = await fetch('/api/ann?op=create', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      credentials:'include',
      body: JSON.stringify({ cell_h3, kind, title, details })
    });
    if (!r.ok) throw new Error('ann create ' + r.status);
    return r.json(); // { ok:true }
  }

  async function voteAnnotation(id, value) {
    const r = await fetch('/api/ann?op=vote', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      credentials:'include',
      body: JSON.stringify({ id, value }) // value = 1 or -1
    });
    if (!r.ok) throw new Error('ann vote ' + r.status);
    return r.json(); // { ok:true, up, down }
  }

    // Search
    document.getElementById('goto').onclick = () => {
      const v = (document.getElementById('search').value||'').trim().toLowerCase();
      const places = { tehran:[51.3890,35.6892], shiraz:[52.5837,29.5918], isfahan:[51.6680,32.6546], tabriz:[46.2738,38.0962], mashhad:[59.6168,36.2605] };
      if (places[v]) map.easeTo({ center: places[v], zoom: 12 });
    };

    // Submit flow
    async function getHashedDevice(){
      let id = localStorage.getItem('deviceId');
      if(!id){ id = [...crypto.getRandomValues(new Uint8Array(32))].map(b=>b.toString(16).padStart(2,'0')).join(''); localStorage.setItem('deviceId', id); }
      const enc = new TextEncoder().encode(id);
      const hash = await crypto.subtle.digest('SHA-256', enc);
      return [...new Uint8Array(hash)].map(b=>b.toString(16).padStart(2,'0')).join('');
    }
    document.getElementById('add').onclick = async () => {
      if (map.getZoom() < 12) { alert('بزرگنمایی را به ۱۲ یا بیشتر برسانید.'); return; }
      try{
        const c = map.getCenter();
        const cell = H3.latLngToCell(c.lat, c.lng, 8);
        const hashedDevice = await getHashedDevice();
        const bucket = +document.getElementById('bucket').value;
        const res = await fetch('/api/submit', {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ h3: cell, bucket, hashedDevice })
        });
        const txt = await res.text(); let json; try{ json = JSON.parse(txt);}catch{}
        if (res.ok){ alert('Saved.'); refreshAgg(); setTimeout(refreshAgg, 1200); }
        else { alert(`Error ${res.status}: ${json?.message || txt.slice(0,140)}`); }
      }catch(e){ alert('Submit failed: '+e.message); }
    };
  </script>
</body>
</html>
