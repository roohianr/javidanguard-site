<!doctype html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>نقشه</title>
  <link rel="stylesheet" href="https://unpkg.com/maplibre-gl/dist/maplibre-gl.css">
  <style>
    html, body { height: 100%; margin: 0; }
    #map { height: 100%; width: 100%; }
    .ui { position:absolute; top:12px; right:12px; z-index:10; display:grid; gap:8px; pointer-events:none; }
    .card { pointer-events:auto; background:rgba(0,0,0,.6); color:#fff; backdrop-filter:blur(6px); border-radius:10px; padding:10px 12px; min-width:280px; }
    .row { display:flex; gap:6px; align-items:center; flex-wrap:wrap; }
    input, select, button { font:inherit; }
    input[type="text"] { flex:1 1 160px; min-width:0; padding:6px 8px; border-radius:8px; border:1px solid #444; background:#111; color:#fff; }
    button { padding:6px 10px; border-radius:8px; border:1px solid #444; background:#1a1a1a; color:#fff; cursor:pointer; }
    button:hover { background:#222; }
    select { padding:6px 8px; border-radius:8px; border:1px solid #444; background:#111; color:#fff; }
    .hint { font-size:12px; opacity:.85; line-height:1.5; margin-top:6px; }
    .pill { font-size:12px; opacity:.9; background:#111; border:1px solid #444; border-radius:999px; padding:2px 8px; }
    .badge{ position:absolute; left:12px; bottom:12px; background:#000a; color:#fff; padding:6px 8px; border-radius:8px; font:12px/1.2 system-ui; }
  </style>
</head>
<body>
  <div id="map"></div>

  <div class="ui">
    <div class="card">
      <div class="row">
        <input id="search" placeholder="جستجوی شهر/منطقه (تهران ۶، شیراز…)" />
        <button id="goto">برو</button>
      </div>
      <div class="hint">برای اعلام گروه‌تان، نقشه را روی <b>محله‌تان</b> ببرید، سپس دکمه زیر را بزنید.</div>
    </div>

    <div class="card">
      <div class="row">
        <span class="pill" id="zoomLabel">زوم: —</span>
        <span class="pill" id="cellLabel">سلول: —</span>
      </div>
      <div class="row" style="margin-top:8px">
        <label>ما چند نفر هستیم:</label>
        <select id="bucket">
          <option value="0">۱</option>
          <option value="1">۲–۵</option>
          <option value="2">۶–۱۰</option>
          <option value="3">۱۱–۲۰</option>
          <option value="4">۲۰+</option>
        </select>
        <button id="add">افزودن گروه</button>
      </div>
      <div class="hint">اطلاعات به صورت ناشناس و در قالب «سلول‌های شش‌ضلعی» ذخیره می‌شود. نقطهٔ دقیق ثبت نمی‌شود.</div>
    </div>
  </div>

  <div class="badge" id="dbg">init…</div>

  <script src="https://unpkg.com/maplibre-gl/dist/maplibre-gl.js"></script>
  <script src="https://unpkg.com/h3-js@4.1.0/dist/h3-js.umd.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.2"></script>
  <script>
    const dbg = (t)=>{ const el=document.getElementById('dbg'); el.textContent=t; console.log('[DBG]',t); };

    // Support both window.h3 (v4 UMD) and older window.h3core names
    const H3 = window.h3 || window.h3core;

    const dataCities = [
      {n:'Tehran', fa:'تهران', lat:35.6892, lng:51.3890},
      {n:'Shiraz', fa:'شیراز', lat:29.5918, lng:52.5837},
      {n:'Isfahan', fa:'اصفهان', lat:32.6546, lng:51.6680},
      {n:'Tabriz', fa:'تبریز', lat:38.0962, lng:46.2738},
      {n:'Mashhad', fa:'مشهد', lat:36.2605, lng:59.6168}
    ];
    const fuse = new Fuse(dataCities, { keys: ['n','fa'], threshold: 0.3 });

    let map;
    try {
      map = new maplibregl.Map({
        container: 'map',
        style: {
          version: 8,
          sources: {
            osm: { type: 'raster', tiles: ['https://tile.openstreetmap.org/{z}/{x}/{y}.png'], tileSize: 256,
              attribution:'© OpenStreetMap contributors' }
          },
          layers: [{ id: 'osm', type: 'raster', source: 'osm' }]
        },
        center: [54, 32], zoom: 4.5, minZoom: 3, maxZoom: 16
      });
      map.addControl(new maplibregl.NavigationControl(), 'top-right');
      map.on('error', e => console.warn('map error', e));
    } catch(e){
      console.error('map init failed', e);
      dbg('map init failed (see console)');
    }

    map.on('load', () => {
      dbg('map loaded');

      // Aggregated cells (crash-proof)
      map.addSource('cells', { type:'geojson', data: fc([]) });
      map.addLayer({
        id:'cells-fill', type:'fill', source:'cells',
        paint:{
          'fill-color': ['step',['get','count'],
            '#0000', 1, '#10b981', 20, '#3b82f6', 50, '#eab308', 100, '#ef4444'],
          'fill-opacity': 0.6
        }
      });
      map.addLayer({ id:'cells-outline', type:'line', source:'cells',
        paint:{ 'line-color':'#fff', 'line-width':1.2, 'line-opacity':0.9 } });

      // Selected hex preview (wrapped in try/catch)
      map.addSource('selected', { type:'geojson', data: fc([]) });
      map.addLayer({ id:'selected-fill', type:'fill', source:'selected',
        paint:{ 'fill-color':'#fff', 'fill-opacity':0.12 }});
      map.addLayer({ id:'selected-line', type:'line', source:'selected',
        paint:{ 'line-color':'#fff', 'line-width':1.2 }});

      updateSelected();
      refreshAgg();
    });

    function fc(features){ return { type:'FeatureCollection', features }; }

    function updateSelected(){
      try{
        const c = map.getCenter();
        if (!H3 || !H3.latLngToCell) throw new Error('H3 not loaded');
        const cell = H3.latLngToCell(c.lat, c.lng, 8);
        const boundary = H3.cellToBoundary(cell, true).map(([lat,lng])=>[lng,lat]);
        map.getSource('selected')?.setData(fc([{ type:'Feature', properties:{cell},
          geometry:{ type:'Polygon', coordinates:[[...boundary, boundary[0]]] } }]));
        document.getElementById('zoomLabel')?.textContent = `زوم: ${map.getZoom().toFixed(1)}`;
        document.getElementById('cellLabel')?.textContent = `سلول: ${cell}`;
      } catch(e){ console.warn('selected error:', e); }
    }

    let t;
    map.on('move', updateSelected);
    map.on('moveend', () => { clearTimeout(t); t=setTimeout(refreshAgg, 250); });

    async function refreshAgg(){
      const b = map.getBounds();
      const z = map.getZoom();
      const url = `/api/agg?bbox=${b.getWest()},${b.getSouth()},${b.getEast()},${b.getNorth()}&z=${z.toFixed(1)}&_t=${Date.now()}`;
      try{
        const r = await fetch(url, { cache:'no-store' });
        if(!r.ok) throw new Error('agg '+r.status);
        const gj = await r.json();
        map.getSource('cells')?.setData(gj);
        dbg(`agg: ${gj.features?.length||0} cells`);
      }catch(e){
        console.warn('agg fetch failed', e);
        dbg('agg error (see console)');
      }
    }

    // Search + Submit (unchanged)
    document.getElementById('goto').onclick = () => {
      const q = (document.getElementById('search').value||'').trim();
      if(!q) return;
      const res = fuse.search(q, { limit:1 });
      if(res.length){
        const {lat,lng} = res[0].item;
        map.easeTo({ center:[lng,lat], zoom:12 });
      }
    };

    async function getHashedDevice(){
      let id = localStorage.getItem('deviceId');
      if(!id){ id = [...crypto.getRandomValues(new Uint8Array(32))].map(b=>b.toString(16).padStart(2,'0')).join(''); localStorage.setItem('deviceId', id); }
      const enc = new TextEncoder().encode(id);
      const hash = await crypto.subtle.digest('SHA-256', enc);
      return [...new Uint8Array(hash)].map(b=>b.toString(16).padStart(2,'0')).join('');
    }

    document.getElementById('add').onclick = async () => {
      if (map.getZoom() < 12) { alert('Zoom in to at least 12.'); return; }
      try{
        const c = map.getCenter();
        if (!H3 || !H3.latLngToCell) throw new Error('H3 not loaded');
        const cell = H3.latLngToCell(c.lat, c.lng, 8);
        const hashedDevice = await getHashedDevice();
        const bucket = +document.getElementById('bucket').value;
        const res = await fetch('/api/submit', {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ h3: cell, bucket, hashedDevice })
        });
        const txt = await res.text(); let json; try{ json=JSON.parse(txt);}catch{}
        if(res.ok){ alert('Saved. May stay hidden until neighbors join.'); refreshAgg(); }
        else { alert(`Error ${res.status}: ${json?.message || txt.slice(0,140)}`); }
      }catch(e){ alert('Submit failed: '+e.message); }
    };
  </script>
</body>
</html>
