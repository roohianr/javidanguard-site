<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>هفته‌های به‌جا نرفته‌ی من</title>
<link rel="preload" href="/assets/Vazirmatn/Vazirmatn-Variable.woff2" as="font" type="font/woff2" crossorigin>
<link rel="stylesheet" href="/css/theme.css">
<link rel="stylesheet" href="/css/components.css">
<style>
  .topbar{display:flex; gap:10px; align-items:center; justify-content:space-between; margin-bottom:14px}
  .controls{display:flex; flex-wrap:wrap; gap:10px; align-items:flex-end}
  .field{display:flex; flex-direction:column; gap:6px}
  .label{font-size:12px; color:var(--muted)}
  .mini{width:90px; background:#0a1221; color:var(--text); border:1px solid rgba(255,255,255,.1); padding:10px 12px; border-radius:10px}
  .mini::-webkit-outer-spin-button,.mini::-webkit-inner-spin-button{ -webkit-appearance: none; margin: 0 }
  .btn{background:#0a1221; color:var(--text); border:1px solid rgba(255,255,255,.1); padding:10px 14px; border-radius:10px; font-weight:700}
  .btn.primary{background:linear-gradient(90deg,var(--accent1),var(--accent2)); color:#00111a; border:none}
  .legend{display:flex; gap:12px; align-items:center; color:var(--muted); font-size:13px}

  .canvas{width:100%; background:rgba(255,255,255,.04); border:1px solid rgba(255,255,255,.08); border-radius:16px; padding:16px; box-shadow:var(--shadow-md)}
  .grid{
    --cols:52; --gap:2px;
    display:grid; grid-template-columns:repeat(var(--cols), 1fr);
    gap:var(--gap); background:rgba(255,255,255,.06); padding:var(--gap); border-radius:10px;
  }
  .cell{
    aspect-ratio:1/1; background:rgba(255,255,255,.02);
    border:1px solid rgba(255,255,255,.06); border-radius:3px; position:relative;
  }
  /* PAST = filled red; FUTURE = empty */
  .cell.past{ background:#ef4444; border-color:#b91c1c }
  /* icons only on past cells */
  .cell.past.sun::after{ content:"☀️"; position:absolute; inset:0; font-size:10px; display:grid; place-items:center }
  .cell.past.poop::after{ content:"💩"; position:absolute; inset:0; font-size:10px; display:grid; place-items:center }

  .meta{display:flex; justify-content:space-between; gap:10px; margin-top:10px; color:var(--muted); font-size:13px}
  .note{margin-top:12px; color:#cbd5e1; font-size:13px; line-height:1.75}

  /* Print: single A3 page */
  @media print{
    @page{ size:A3 portrait; margin:10mm }
    body{ background:#fff; color:#000 }
    .emblem,.user-btn,.btn.primary,.btn.calc{ display:none!important }
    .canvas{ box-shadow:none; border:0; padding:0 }
    .legend,.note{ color:#111 }
    .grid{
      --gap:1mm;
      gap:var(--gap); padding:0;
      grid-template-columns: repeat(52, calc((100% - 51 * var(--gap)) / 52));
    }
    .cell{ border:0.2mm solid #777 }
    .cell.past{ background:#ffc5c5 !important } /* light red for paper */
  }
</style>
</head>
<body>
  <!-- watermark -->
  <img class="emblem" src="/assets/lion-sun.svg" alt="شیر و خورشید">
  <!-- top-right user button -->
  <a class="user-btn" href="/login.html" aria-label="ورود به داشبورد">
    <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
      <path d="M12 12c2.761 0 5-2.462 5-5.5S14.761 1 12 1 7 3.462 7 6.5 9.239 12 12 12Zm0 2c-4.97 0-9 3.582-9 8 0 .552.448 1 1 1h16c.552 0 1-.448 1-1 0-4.418-4.03-8-9-8Z" fill="currentColor"/>
    </svg>
  </a>

  <div class="wrap" style="justify-content:flex-start">
    <div class="title" style="margin-top:18px">
      <h1>هفته‌های به‌جا نرفته‌ی من</h1>
      <div class="subtitle">هر خانه یک هفته از زندگی توست. فقط هفته‌های گذشته پر می‌شوند.</div>
    </div>

    <div class="canvas">
      <div class="topbar">
        <div class="controls">
          <div class="field">
            <label class="label" for="jy">سال (جلالی)</label>
            <input id="jy" class="mini" type="number" inputmode="numeric" placeholder="1370" min="1200" max="1500">
          </div>
          <div class="field">
            <label class="label" for="jm">ماه</label>
            <input id="jm" class="mini" type="number" inputmode="numeric" placeholder="05" min="1" max="12">
          </div>
          <div class="field">
            <label class="label" for="jd">روز</label>
            <input id="jd" class="mini" type="number" inputmode="numeric" placeholder="04" min="1" max="31">
          </div>
          <div class="field">
            <label class="label" for="expect">امید به زندگی (سال)</label>
            <input id="expect" class="mini" type="number" value="78" min="40" max="120" step="1">
          </div>
          <button class="btn calc" onclick="build()">محاسبه</button>
          <button id="printBtn" class="btn primary" onclick="window.print()" hidden>پرینت A3</button>
        </div>
        <div class="legend">
          <span>☀️ قبل از ۱ بهمن ۱۳۵۷</span>
          <span>💩 بعد از آن</span>
        </div>
      </div>

      <div id="grid" class="grid" aria-label="گرید هفته‌ها"></div>

      <div class="meta">
        <div id="statsLeft"></div>
        <div id="statsRight"></div>
      </div>

      <div class="note">
        <strong>توضیحات:</strong>
        <ul style="margin:6px 0 0 0; padding-right:18px">
          <li>اگر از میانگین جلوتر بودی، نمایش تا «سن فعلی + ۵ سال» ادامه می‌یابد.</li>
          <li>دکمهٔ پرینت پس از محاسبه فعال می‌شود و در نسخهٔ چاپی نمایش داده نمی‌شود.</li>
          <li>مرز تاریخی نمایش: <strong>۱ بهمن ۱۳۵۷</strong> — قبل از آن ☀️، بعد از آن 💩 (فقط برای هفته‌های گذشته).</li>
        </ul>
      </div>
    </div>
  </div>

<script>
/* === JALALI → GREGORIAN ============================================ */
function jalaliToGregorian(jy, jm, jd){
  jy = parseInt(jy,10); jm = parseInt(jm,10); jd = parseInt(jd,10);
  var gy;
  var j_day_no = 365*jy + Math.floor(jy/33)*8 + Math.floor(((jy%33)+3)/4);
  for (var i=1; i<jm; i++) j_day_no += (i<=6)?31:(i<=11?30:29);
  j_day_no += jd + 226899;
  gy = 1600 + 400*Math.floor(j_day_no/146097);
  j_day_no %= 146097;
  var leap = true;
  if (j_day_no >= 36525){
    j_day_no--; gy += 100*Math.floor(j_day_no/36524);
    j_day_no %= 36524;
    if (j_day_no >= 365) j_day_no++; else leap = false;
  }
  gy += 4*Math.floor(j_day_no/1461);
  j_day_no %= 1461;
  if (j_day_no >= 366){
    leap = false;
    j_day_no -= 1;
    gy += Math.floor(j_day_no/365);
    j_day_no %= 365;
  }
  var gd = j_day_no + 1;
  var sal_a = [0,31,(leap?29:28),31,30,31,30,31,31,30,31,30,31];
  var gm;
  for (gm=1; gm<=12; gm++){
    if (gd <= sal_a[gm]) break;
    gd -= sal_a[gm];
  }
  return [gy, gm, gd];
}
function j2gDate(jy, jm, jd){
  const [gy, gm, gd] = jalaliToGregorian(jy, jm, jd);
  return new Date(Date.UTC(gy, gm-1, gd));
}

/* Revolution boundary: ۱ بهمن ۱۳۵۷ (Jalali month 11) */
const REVOLUTION = j2gDate(1357, 11, 1);

const gridEl = document.getElementById('grid');
const printBtn = document.getElementById('printBtn');
const statsLeft = document.getElementById('statsLeft');
const statsRight = document.getElementById('statsRight');

function weeksBetween(a,b){ return Math.floor((b - a) / (1000*60*60*24*7)); }
function addWeeks(date, w){ const d = new Date(date); d.setUTCDate(d.getUTCDate() + w*7); return d; }

function build(){
  const jy = +document.getElementById('jy').value;
  const jm = +document.getElementById('jm').value;
  const jd = +document.getElementById('jd').value;
  const expect = Math.max(40, Math.min(120, +document.getElementById('expect').value||78));

  if(!jy || !jm || !jd || jm<1 || jm>12 || jd<1 || jd>31){
    alert('سال/ماه/روز جلالی را درست وارد کن (مثلاً 1370 / 05 / 04).');
    return;
  }

  const dob = j2gDate(jy, jm, jd);
  const today = new Date();

  const ageWeeks = Math.max(0, weeksBetween(dob, today));
  const ageYears = ageWeeks / 52;
  const displayYears = Math.max(expect, Math.ceil(ageYears + 5));
  const totalWeeks = displayYears * 52;

  gridEl.textContent = '';
  for(let w=0; w<totalWeeks; w++){
    const cellDate = addWeeks(dob, w);
    const isPast = cellDate <= today;
    const isSun = cellDate < REVOLUTION;
    const div = document.createElement('div');
    div.className = 'cell' + (isPast ? ' past' : '') + (isSun ? ' sun' : ' poop');
    gridEl.appendChild(div);
  }

  printBtn.hidden = false;

  const left = Math.max(0, totalWeeks - ageWeeks);
  statsLeft.textContent = `هفته‌های گذشته: ${ageWeeks.toLocaleString('fa-IR')}`;
  statsRight.textContent = `هفته‌های باقی‌مانده تا ${displayYears} سال: ${left.toLocaleString('fa-IR')}`;

  // remember inputs
  localStorage.setItem('wofl-jy', String(jy));
  localStorage.setItem('wofl-jm', String(jm).padStart(2,'0'));
  localStorage.setItem('wofl-jd', String(jd).padStart(2,'0'));
}

/* restore inputs */
(function(){
  const jy=document.getElementById('jy'), jm=document.getElementById('jm'), jd=document.getElementById('jd');
  jy.value = localStorage.getItem('wofl-jy') || '';
  jm.value = localStorage.getItem('wofl-jm') || '';
  jd.value = localStorage.getItem('wofl-jd') || '';
})();
</script>
</body>
</html>
