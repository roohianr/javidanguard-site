<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Ù‡ÙØªÙ‡â€ŒÙ‡Ø§ÛŒ Ø¨Ù‡â€ŒØ¬Ø§ Ù†Ø±ÙØªÙ‡â€ŒÛŒ Ù…Ù†</title>

<!-- Optional: keep your site-wide styles; our rules below are scoped -->
<link rel="stylesheet" href="/css/theme.css">
<link rel="stylesheet" href="/css/components.css">

<style>
/* ---------- Page fonts (self-hosted) ---------- */
@font-face{
  font-family:"Vazirmatn";
  src:url("/assets/Vazirmatn/Vazirmatn-Variable.woff2") format("woff2-variations");
  font-weight:100 900; font-style:normal; font-display:swap;
}

/* ---------- Scope everything to #wofl to avoid leaks ---------- */
#wofl{ --bg1:#0f172a; --bg2:#1e293b; --text:#e5e7eb; --muted:#93a5b1;
       --accent1:#22d3ee; --accent2:#38bdf8;
       --card-bg1:rgba(255,255,255,.04); --card-bg2:rgba(255,255,255,.02);
       --card-br:16px; --shadow:0 24px 60px rgba(0,0,0,.35);
       --sun-bg:rgba(56,189,248,.38); --sun-br:rgba(2,132,199,.55);
       --poop-bg:rgba(239,68,68,.38); --poop-br:rgba(185,28,28,.55);
       font-family:Vazirmatn,system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans Arabic",Tahoma,sans-serif;
       color:var(--text);
}
#wofl a{color:inherit;text-decoration:none}
#wofl img{max-width:100%;display:block}

/* background + chrome */
body{ background:
  radial-gradient(1200px 800px at 80% -20%, #1f2937 0%, #0f172a 60%),
  linear-gradient(180deg, #0f172a, #1e293b);
  margin:0;
}
#wofl .emblem{ position:fixed; top:16px; left:16px; width:64px; opacity:.15; filter:grayscale(100%); pointer-events:none }
#wofl .user-btn{ position:fixed; top:14px; right:14px; width:42px; height:42px; display:grid; place-items:center;
  border-radius:12px; background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.12);
  backdrop-filter:blur(6px); box-shadow:0 10px 30px rgba(0,0,0,.25) }
#wofl .user-btn svg{ width:22px; height:22px; color:#e5e7eb }

/* layout */
#wofl .wrap{ max-width:1100px; margin:auto; padding:20px; min-height:100%;
  display:flex; flex-direction:column; gap:16px; align-items:stretch; justify-content:flex-start }
#wofl .title{ text-align:right; margin-top:18px }
#wofl .title h1{ margin:0; font-weight:800; font-size:clamp(22px,4.6vw,34px) }
#wofl .title .subtitle{ color:var(--muted); font-size:14px; margin-top:6px }

#wofl .canvas{ background:linear-gradient(180deg,var(--card-bg1),var(--card-bg2));
  border:1px solid rgba(255,255,255,.08); border-radius:var(--card-br);
  box-shadow:var(--shadow); padding:16px }

/* controls */
#wofl .topbar{ display:flex; align-items:flex-end; justify-content:space-between; gap:12px; flex-wrap:wrap; margin-bottom:12px }
#wofl .controls{ display:flex; align-items:flex-end; gap:10px; flex-wrap:wrap }
#wofl .field{ display:flex; flex-direction:column; gap:6px }
#wofl .label{ font-size:12px; color:var(--muted) }
#wofl .input, #wofl select{ width:120px; background:#0a1221; color:var(--text);
  border:1px solid rgba(255,255,255,.12); border-radius:10px; padding:10px 12px }
#wofl .input::-webkit-outer-spin-button,#wofl .input::-webkit-inner-spin-button{ -webkit-appearance:none; margin:0 }
#wofl .btn{ background:linear-gradient(90deg,var(--accent1),var(--accent2)); color:#00111a;
  border:none; border-radius:10px; padding:10px 14px; font-weight:800 }
#wofl .legend{ display:flex; gap:12px; align-items:center; color:var(--muted); font-size:13px }

/* fact rectangles */
#wofl .facts{ display:grid; gap:10px; grid-template-columns:repeat(3,1fr); margin-bottom:12px }
@media (max-width:900px){ #wofl .facts{ grid-template-columns:1fr } }
#wofl .fact{ background:rgba(255,255,255,.04); border:1px solid rgba(255,255,255,.08);
  border-radius:12px; padding:12px }
#wofl .fact .num{ font-weight:800; font-size:22px }
#wofl .fact .lbl{ color:var(--muted); font-size:12px; margin-top:4px }

/* grid */
#wofl .grid{ --cols:52; --gap:2px; display:grid; grid-template-columns:repeat(var(--cols),1fr);
  gap:var(--gap); background:rgba(255,255,255,.06); padding:var(--gap); border-radius:10px }
#wofl .cell{ aspect-ratio:1/1; background:rgba(255,255,255,.02);
  border:1px solid rgba(255,255,255,.06); border-radius:3px; position:relative; overflow:hidden }

/* neutralize ANY global dot styles from theme/components */
#wofl .cell{ background-image:none !important; box-shadow:none !important; mix-blend-mode:normal !important; filter:none !important }
#wofl .cell::after{ content:none !important }

/* past weeks get colored by era; future stays empty */
#wofl .cell.past{ background:transparent; border-color:rgba(255,255,255,.12) }
#wofl .cell.past.sun  { background:var(--sun-bg);  border-color:var(--sun-br) }
#wofl .cell.past.poop { background:var(--poop-bg); border-color:var(--poop-br) }

/* soft sheen under emoji */
#wofl .cell.past::before{ content:""; position:absolute; inset:0; border-radius:3px;
  background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,0)); pointer-events:none; z-index:0 }

/* REAL emoji element (sits on top, mobile-safe) */
#wofl .cell .emoji{ position:relative; z-index:2; display:flex; align-items:center; justify-content:center;
  width:100%; height:100%; line-height:1;
  font-family:"Apple Color Emoji","Segoe UI Emoji","Noto Color Emoji","Twemoji Mozilla",system-ui,sans-serif !important;
  font-size:clamp(12px, calc(var(--cellpx, 14px) * 0.78), 22px);
  transform:translateY(0.4px); -webkit-font-smoothing:antialiased; text-rendering:optimizeLegibility }

/* misc */
#wofl .meta{ display:flex; justify-content:space-between; gap:10px; margin-top:10px; color:var(--muted); font-size:13px }
#wofl .note{ margin-top:12px; color:#cbd5e1; font-size:13px; line-height:1.75 }
#wofl .note strong{ color:#e5e7eb }
</style>
</head>
<body>

<div id="wofl">
  <!-- watermark + user -->
  <img class="emblem" src="/assets/lion-sun.svg" alt="Ø´ÛŒØ± Ùˆ Ø®ÙˆØ±Ø´ÛŒØ¯">
  <a class="user-btn" href="/login.html" aria-label="ÙˆØ±ÙˆØ¯ Ø¨Ù‡ Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯">
    <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
      <path d="M12 12c2.761 0 5-2.462 5-5.5S14.761 1 12 1 7 3.462 7 6.5 9.239 12 12 12Zm0 2c-4.97 0-9 3.582-9 8 0 .552.448 1 1 1h16c.552 0 1-.448 1-1 0-4.418-4.03-8-9-8Z" fill="currentColor"/>
    </svg>
  </a>

  <div class="wrap">
    <div class="title">
      <h1>Ù‡ÙØªÙ‡â€ŒÙ‡Ø§ÛŒ Ø¨Ù‡â€ŒØ¬Ø§ Ù†Ø±ÙØªÙ‡Ù” Ù…Ù†</h1>
      <div class="subtitle">
        Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† Ø¹Ù…Ø± Ø§ÛŒØ±Ø§Ù†ÛŒâ€ŒÙ‡Ø§: <b>Û·Û·Ù«Û·</b> Ø³Ø§Ù„ (Ù‚Ø§Ø¨Ù„ ØªØºÛŒÛŒØ±). Ù¾ÛŒØ´ Ø§Ø² Ù…Ø±Ø² <b>Û±Û² Ø¨Ù‡Ù…Ù† Û±Û³ÛµÛ·</b> Ø¨Ø§ â˜€ï¸ØŒ Ù¾Ø³ Ø§Ø² Ø¢Ù† Ø¨Ø§ ğŸ’©.
      </div>
    </div>

    <div class="canvas">
      <div class="topbar">
        <div class="controls">
          <div class="field">
            <label class="label" for="jy">Ø³Ø§Ù„ (Ø¬Ù„Ø§Ù„ÛŒ)</label>
            <input id="jy" class="input" type="number" inputmode="numeric" placeholder="1369" min="1200" max="1500">
          </div>
          <div class="field">
            <label class="label" for="jm">Ù…Ø§Ù‡</label>
            <select id="jm">
              <option value="1">ÙØ±ÙˆØ±Ø¯ÛŒÙ†</option><option value="2">Ø§Ø±Ø¯ÛŒØ¨Ù‡Ø´Øª</option><option value="3">Ø®Ø±Ø¯Ø§Ø¯</option>
              <option value="4">ØªÛŒØ±</option><option value="5">Ù…Ø±Ø¯Ø§Ø¯</option><option value="6">Ø´Ù‡Ø±ÛŒÙˆØ±</option>
              <option value="7">Ù…Ù‡Ø±</option><option value="8">Ø¢Ø¨Ø§Ù†</option><option value="9">Ø¢Ø°Ø±</option>
              <option value="10">Ø¯ÛŒ</option><option value="11">Ø¨Ù‡Ù…Ù†</option><option value="12">Ø§Ø³ÙÙ†Ø¯</option>
            </select>
          </div>
          <div class="field">
            <label class="label" for="jd">Ø±ÙˆØ²</label>
            <input id="jd" class="input" type="number" inputmode="numeric" placeholder="3" min="1" max="31">
          </div>
          <div class="field">
            <label class="label" for="expect">Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† (Ø³Ø§Ù„)</label>
            <input id="expect" class="input" type="number" value="77.7" step="0.1" min="40" max="120">
          </div>
          <button class="btn" id="calcBtn">Ù…Ø­Ø§Ø³Ø¨Ù‡</button>
        </div>
        <div class="legend">
          <span>â˜€ï¸ Ù¾ÛŒØ´ Ø§Ø² Ù…Ø±Ø²</span>
          <span>ğŸ’© Ù¾Ø³ Ø§Ø² Ù…Ø±Ø²</span>
        </div>
      </div>

      <!-- facts -->
      <div class="facts">
        <div class="fact"><div class="num" id="f-lived">â€”</div><div class="lbl">Ù‡ÙØªÙ‡ Ø²Ù†Ø¯Ú¯ÛŒ Ú©Ø±Ø¯Ù‡â€ŒØ§ÛŒ</div></div>
        <div class="fact"><div class="num" id="f-sunpoop">â€”</div><div class="lbl">Ø§Ø² Ø§ÛŒÙ† ØªØ¹Ø¯Ø§Ø¯: â˜€ï¸ Ù‚Ø¨Ù„ Ø§Ø² Û±Û² Ø¨Ù‡Ù…Ù† / ğŸ’© Ø¨Ø¹Ø¯ Ø§Ø² Ø¢Ù†</div></div>
        <div class="fact"><div class="num" id="f-left">â€”</div><div class="lbl">Ù‡ÙØªÙ‡ ØªØ§ Ø§ÙÙ‚ Ù†Ù…Ø§ÛŒØ´</div></div>
      </div>

      <!-- grid -->
      <div id="grid" class="grid" aria-label="Ú¯Ø±ÛŒØ¯ Ù‡ÙØªÙ‡â€ŒÙ‡Ø§"></div>

      <div class="meta">
        <div id="statsLeft"></div>
        <div id="statsRight"></div>
      </div>

      <div class="note">
        <strong>Ú†Ø±Ø§ Û±Û² Ø¨Ù‡Ù…Ù†ØŸ</strong>
        Ú†ÙˆÙ† Ø¨Ø§ÙˆØ± Ø¯Ø§Ø±Ù… Ø§ØªÙ„Ø§Ù Ø²Ù†Ø¯Ú¯ÛŒ Ù…Ø§ Ø§Ø² ÙˆÙ‚ØªÛŒ Ø´Ø±ÙˆØ¹ Ø´Ø¯ Ú©Ù‡ <strong>Ø´Ø§Ù‡ Ø±ÙØª</strong>ØŒ Ù†Ù‡ ÙˆÙ‚ØªÛŒ Ú©Ù‡ <strong>Ø®Ù…ÛŒÙ†ÛŒ Ø¢Ù…Ø¯</strong>.
        Ù…Ø±Ø² Ø§ÛŒÙ† ØµÙØ­Ù‡ Ø±Ø§ <strong>Û±Û² Ø¨Ù‡Ù…Ù† Û±Û³ÛµÛ·</strong> Ú¯Ø°Ø§Ø´ØªÙ‡â€ŒØ§Ù…Ø› Ù‡Ø± Ú†Ù‡ Ù¾ÛŒØ´ Ø§Ø² Ø¢Ù† Ø¨ÙˆØ¯ Ø¨Ø§ â˜€ï¸ Ùˆ Ù¾Ø³ Ø§Ø² Ø¢Ù† Ø¨Ø§ ğŸ’© Ù†Ø´Ø§Ù†Ù‡â€ŒÚ¯Ø°Ø§Ø±ÛŒ Ù…ÛŒâ€ŒØ´ÙˆØ¯
        (ÙÙ‚Ø· Ø¨Ø±Ø§ÛŒ Ù‡ÙØªÙ‡â€ŒÙ‡Ø§ÛŒ Ú¯Ø°Ø´ØªÙ‡).
      </div>
    </div>
  </div>
</div>

<script>
/* ===== Jalali â†’ Gregorian (UTC-safe) ===== */
function j2g(jy, jm, jd){
  var jy2 = jy - 979, jm2 = jm - 1, jd2 = jd - 1;
  var j_day_no = 365*jy2 + Math.floor(jy2/33)*8 + Math.floor((jy2%33 + 3)/4);
  for (var i=0; i<jm2; ++i) j_day_no += (i<6)?31:30;
  j_day_no += jd2;
  var g_day_no = j_day_no + 79;
  var gy = 1600 + 400*Math.floor(g_day_no/146097); g_day_no %= 146097;
  var leap = true;
  if (g_day_no >= 36525){ g_day_no--; gy += 100*Math.floor(g_day_no/36524); g_day_no %= 36524; if (g_day_no >= 365) g_day_no++; else leap=false; }
  gy += 4*Math.floor(g_day_no/1461); g_day_no %= 1461;
  if (g_day_no >= 366){ leap=false; g_day_no--; gy += Math.floor(g_day_no/365); g_day_no %= 365; }
  var gd = g_day_no + 1, sal=[0,31,(leap?29:28),31,30,31,30,31,31,30,31,30,31], gm=1;
  while (gm<=12 && gd>sal[gm]){ gd -= sal[gm++]; }
  return [gy, gm, gd];
}
function jDateUTC(jy,jm,jd){ const [gy,gm,gd] = j2g(jy,jm,jd); return new Date(Date.UTC(gy, gm-1, gd)); }
function todayUTC(){ const t=new Date(); return new Date(Date.UTC(t.getUTCFullYear(), t.getUTCMonth(), t.getUTCDate())); }
function addWeeksUTC(date, w){ return new Date(date.getTime() + w*7*24*60*60*1000); }
function weeksBetweenUTC(a,b){ return Math.floor((b - a) / (7*24*60*60*1000)); }

/* Boundary: Û±Û² Ø¨Ù‡Ù…Ù† Û±Û³ÛµÛ· */
const REVOLUTION = jDateUTC(1357,11,12);

/* DOM refs (scoped) */
const gridEl   = document.getElementById('grid');
const fLived   = document.getElementById('f-lived');
const fSunPoop = document.getElementById('f-sunpoop');
const fLeft    = document.getElementById('f-left');
const statsLeft  = document.getElementById('statsLeft');
const statsRight = document.getElementById('statsRight');
const calcBtn    = document.getElementById('calcBtn');

/* Build grid + facts */
function build(){
  const jy = +document.getElementById('jy').value;
  const jm = +document.getElementById('jm').value;
  const jd = +document.getElementById('jd').value;
  const exp = Math.max(40, Math.min(120, +document.getElementById('expect').value || 77.7));

  if(!jy || !jm || !jd || jm<1 || jm>12 || jd<1 || jd>31){
    alert('Ø³Ø§Ù„/Ù…Ø§Ù‡/Ø±ÙˆØ² Ø¬Ù„Ø§Ù„ÛŒ Ø±Ø§ Ø¯Ø±Ø³Øª ÙˆØ§Ø±Ø¯ Ú©Ù† (Ù…Ø«Ù„Ø§Ù‹ 1369 / Ø®Ø±Ø¯Ø§Ø¯ / 3).');
    return;
  }

  const dob = jDateUTC(jy,jm,jd);
  const today = todayUTC();

  const ageWeeks = Math.max(0, weeksBetweenUTC(dob, today));
  const ageYears = ageWeeks / 52;
  const displayYears = Math.max(Math.ceil(exp), Math.ceil(ageYears + 5));
  const totalWeeks = displayYears * 52;

  // counts for facts (only among past weeks)
  let sunWeeks = 0;
  if (dob < REVOLUTION) {
    const sunEnd = (today < REVOLUTION) ? today : REVOLUTION;
    sunWeeks = Math.max(0, weeksBetweenUTC(dob, sunEnd));
  }
  const poopPastWeeks = Math.max(0, ageWeeks - sunWeeks);
  const leftWeeks = Math.max(0, totalWeeks - ageWeeks);

  // facts
  fLived.textContent   = ageWeeks.toLocaleString('fa-IR');
  fSunPoop.textContent = `â˜€ï¸ ${sunWeeks.toLocaleString('fa-IR')}  /  ğŸ’© ${poopPastWeeks.toLocaleString('fa-IR')}`;
  fLeft.textContent    = leftWeeks.toLocaleString('fa-IR');

  // grid
  gridEl.textContent = '';
  for (let w=0; w<totalWeeks; w++){
    const d = addWeeksUTC(dob, w);
    const isPast = d <= today;
    const isSun  = d < REVOLUTION;

    const cell = document.createElement('div');
    cell.className = 'cell' + (isPast ? ' past' : '') + (isSun ? ' sun' : ' poop');

    if (isPast) {
      const em = document.createElement('span');
      em.className = 'emoji';
      em.textContent = isSun ? 'â˜€ï¸' : 'ğŸ’©';
      cell.appendChild(em);
    }

    gridEl.appendChild(cell);
  }

  // extra stats (optional)
  statsLeft.textContent  = `Ø³Ù†: ${ageYears.toFixed(1)} Ø³Ø§Ù„`;
  statsRight.textContent = `Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† Ù…Ø¨Ù†Ø§: ${Math.ceil(exp)} Ø³Ø§Ù„ â€¢ Ø¨Ø§Ù‚ÛŒâ€ŒÙ…Ø§Ù†Ø¯Ù‡: ${leftWeeks.toLocaleString('fa-IR')} Ù‡ÙØªÙ‡`;

  // remember inputs
  localStorage.setItem('wofl-jy', String(jy));
  localStorage.setItem('wofl-jm', String(jm));
  localStorage.setItem('wofl-jd', String(jd));

  // size emojis to cell
  updateEmojiScale();
}

/* Emoji scale follows cell size (mobile-friendly) */
function updateEmojiScale(){
  const first = gridEl.querySelector('.cell');
  if(!first) return;
  const r = first.getBoundingClientRect();
  gridEl.style.setProperty('--cellpx', Math.min(r.width, r.height) + 'px');
}
let _resizeTO;
window.addEventListener('resize', () => {
  clearTimeout(_resizeTO);
  _resizeTO = setTimeout(updateEmojiScale, 120);
});

/* restore inputs */
(function(){
  const jyI=document.getElementById('jy'), jmI=document.getElementById('jm'), jdI=document.getElementById('jd');
  jyI.value = localStorage.getItem('wofl-jy') || '';
  jmI.value = localStorage.getItem('wofl-jm') || '3';  // Ù¾ÛŒØ´â€ŒÙØ±Ø¶: Ø®Ø±Ø¯Ø§Ø¯
  jdI.value = localStorage.getItem('wofl-jd') || '';
})();

/* bind */
calcBtn.addEventListener('click', build);
</script>
</body>
</html>
